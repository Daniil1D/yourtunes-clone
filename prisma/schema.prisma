// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("POSTGRES_PRISMA_URL")
  directUrl = env("POSTGRES_URL_NON_POOLING")
}

model User {
  id       String    @id @default(cuid())
  email    String    @unique
  password String
  fullName String
  role     UserRole  @default(USER)
  verified DateTime?
  avatarUrl String?

  artists Artist[]
  labels  Label[]  @relation("LabelOwners")
  files   File[]

  provider   String?
  providerId String?

  subscriptions Subscription[]
  cartItems     CartItem[]
  orders        Order[]
  releases      Release[]
  transaction   Transaction[]

  auditLogs        AuditLog[]
  verificationCode VerificationCode?

  balance  Int      @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Artist {
  id     String @id @default(cuid())
  name   String
  userId String
  user   User   @relation(fields: [userId], references: [id])

  releases Release[]

  createdAt DateTime @default(now())
}

model Label {
  id   String @id @default(cuid())
  name String

  owners   User[]    @relation("LabelOwners")
  releases Release[]

  createdAt DateTime @default(now())
}

model Release {
  id          String        @id @default(cuid())
  title       String
  type        ReleaseType
  status      ReleaseStatus @default(DRAFT)
  releaseDate DateTime?

  genre   String?
  version String?

  artistId String
  artist   Artist @relation(fields: [artistId], references: [id])

  labelId String?
  label   Label?  @relation(fields: [labelId], references: [id])

  tracks Track[]

  platforms ReleasePlatform[]

  artistCard ArtistCard[]

  userId String
  user   User   @relation(fields: [userId], references: [id])

  coverId String? @unique
  cover   File?   @relation(fields: [coverId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Track {
  id       String      @id @default(cuid())

  title    String
  audioUrl  String?
  duration  Int?
  status   TrackStatus @default(DRAFT)

  audioFileId String? @unique
  audioFile   File?   @relation(fields: [audioFileId], references: [id])

  releaseId String
  release   Release @relation(fields: [releaseId], references: [id])

  artists   TrackArtist[]
  feats     TrackFeat[]

  createdAt DateTime @default(now())
}

model TrackArtist {
  id      String @id @default(cuid())
  name    String

  trackId String
  track   Track @relation(fields: [trackId], references: [id], onDelete: Cascade)
}

model ArtistCard {
  id String @id @default(cuid())

  name String

  spotifyUrl    String?
  appleMusicUrl String?
  socialUrl     String?

  releaseId String
  release   Release @relation(fields: [releaseId], references: [id], onDelete: Cascade)

  ready Boolean @default(false)

  createdAt DateTime @default(now())

  @@unique([name, releaseId])
}

model TrackFeat {
  id      String @id @default(cuid())
  name    String

  trackId String
  track   Track @relation(fields: [trackId], references: [id], onDelete: Cascade)
}

model File {
  id       String   @id @default(cuid())
  type     FileType
  url      String
  size     Int
  mimeType String

  uploadedBy String
  uploader   User   @relation(fields: [uploadedBy], references: [id])

  coverFor Release?
  audioFor Track?

  createdAt DateTime @default(now())
}

model Subscription {
  id     String  @id @default(cuid())
  active Boolean @default(true)

  planId SubscriptionPlan
  plan   Plan             @relation(fields: [planId], references: [id])

  userId String
  user   User   @relation(fields: [userId], references: [id])

  startedAt DateTime  @default(now())
  expiresAt DateTime?
  orderId   String? // Ссылка на оплату (если нужно)
  order     Order?    @relation(fields: [orderId], references: [id])

  @@unique([userId, planId, active])
}

model AuditLog {
  id       String @id @default(cuid())
  action   String
  entity   String
  entityId String

  userId String
  user   User   @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now())
}

model Invite {
  id    String   @id @default(cuid())
  email String
  role  UserRole

  token     String   @unique
  expiresAt DateTime

  createdAt DateTime @default(now())
}

model VerificationCode {
  id String @id @default(cuid())

  user   User   @relation(fields: [userId], references: [id])
  userId String @unique

  code String

  createdAt DateTime @default(now())

  @@unique([userId, code])
}

model Plan {
  id          SubscriptionPlan @id
  title       String
  description String
  price       Int
  oldPrice    Int?
  period      String
  highlighted Boolean          @default(false)

  features      PlanFeature[]
  subscriptions Subscription[]
  cartItems     CartItem[]
  orderItems    OrderItem[]

  createdAt DateTime @default(now())
}

model PlanFeature {
  id   String @id @default(cuid())
  text String

  planId SubscriptionPlan
  plan   Plan             @relation(fields: [planId], references: [id])
}

model CartItem {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id])

  planId SubscriptionPlan
  plan   Plan             @relation(fields: [planId], references: [id])

  quantity Int @default(1)

  createdAt DateTime @default(now())

  @@unique([userId])
}

model Order {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id])

  status OrderStatus @default(PENDING)
  total  Int

  paymentId     String?
  subscriptions Subscription[]

  items     OrderItem[]

  type   OrderType @default(SUBSCRIPTION)
  
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
}

model OrderItem {
  id      String @id @default(cuid())
  orderId String
  order   Order  @relation(fields: [orderId], references: [id])

  planId SubscriptionPlan
  plan   Plan             @relation(fields: [planId], references: [id])

  price    Int
  quantity Int @default(1)
}

model Platform {
  id        String       @id @default(cuid())
  name      String
  type      PlatformType
  logo      String?      // иконка
  active    Boolean      @default(true)

  releases  ReleasePlatform[]

  createdAt DateTime @default(now())

  @@unique([name])
}

model ReleasePlatform {
  id         String   @id @default(cuid())

  releaseId  String
  release    Release  @relation(fields: [releaseId], references: [id], onDelete: Cascade)

  platformId String
  platform   Platform @relation(fields: [platformId], references: [id], onDelete: Cascade)

  createdAt  DateTime @default(now())

  @@unique([releaseId, platformId])
}

model Transaction {
  id        String   @id @default(uuid())
  userId    String
  amount    Int
  type      String
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
}

enum UserRole {
  USER
  ADMIN
  MODERATOR
}

enum ReleaseType {
  SINGLE
  EP
  ALBUM
}

enum ReleaseStatus {
  DRAFT
  SUBMITTED
  IN_REVIEW
  APPROVED
  REJECTED
  DISTRIBUTED
}

enum TrackStatus {
  DRAFT
  READY
}

enum FileType {
  AUDIO
  IMAGE
  DOCUMENT
}

enum SubscriptionPlan {
  FREE
  PRO
  LABEL
}

enum OrderStatus {
  PENDING
  PAID
  CANCELLED
}

enum PlatformType {
  STREAMING
  UGC
}

enum OrderType {
  SUBSCRIPTION
  BALANCE_TOPUP
}
